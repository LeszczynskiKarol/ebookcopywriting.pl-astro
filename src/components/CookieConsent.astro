---
/**
 * CookieConsent.astro
 * GDPR/RODO compliant cookie consent banner
 * - Banner z wyborem: Akceptuj wszystkie / OdrzuÄ‡ opcjonalne / Ustawienia
 * - Modal z granularnym wyborem kategorii
 * - GA4 Å‚adowane TYLKO po zgodzie na analityczne
 * - Zgoda zapisywana w cookie (12 miesiÄ™cy)
 * - MoÅ¼liwoÅ›Ä‡ zmiany w kaÅ¼dej chwili (przycisk "Cookies" w footerze)
 * - Bez Google Tag Manager â€” bezpoÅ›redni gtag.js
 */

const GA_ID = 'G-VMQMVTNPLT';
---

<!-- Cookie Consent Banner -->
<div id="cookie-banner" class="fixed bottom-0 left-0 right-0 z-[9999] hidden" role="dialog" aria-label="Zgoda na pliki cookie" aria-modal="false">
  <div class="bg-navy-900/98 backdrop-blur-md border-t border-slate-700 shadow-2xl">
    <div class="max-w-6xl mx-auto px-4 py-5 md:py-6">
      <div class="md:flex md:items-start md:gap-6">
        <!-- Tekst -->
        <div class="flex-1 mb-4 md:mb-0">
          <h3 class="text-white font-bold text-base mb-2">ğŸª Ta strona uÅ¼ywa plikÃ³w cookie</h3>
          <p class="text-slate-300 text-sm leading-relaxed">
            Korzystamy z niezbÄ™dnych plikÃ³w cookie, ktÃ³re zapewniajÄ… prawidÅ‚owe dziaÅ‚anie strony.
            Za TwojÄ… zgodÄ… uÅ¼ywamy takÅ¼e analitycznych plikÃ³w cookie (Google Analytics), 
            aby zrozumieÄ‡, jak korzystasz ze strony i jÄ… ulepszaÄ‡.
            <button id="cookie-show-details" class="text-primary-400 hover:text-primary-300 underline underline-offset-2 transition-colors">SzczegÃ³Å‚y</button>
          </p>
        </div>
        <!-- Przyciski -->
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 shrink-0">
          <button id="cookie-reject" class="px-5 py-2.5 text-sm font-medium text-slate-300 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg transition-colors">
            Tylko niezbÄ™dne
          </button>
          <button id="cookie-settings-btn" class="px-5 py-2.5 text-sm font-medium text-slate-300 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg transition-colors">
            Ustawienia
          </button>
          <button id="cookie-accept-all" class="px-5 py-2.5 text-sm font-bold text-white bg-primary-600 hover:bg-primary-700 rounded-lg transition-colors">
            AkceptujÄ™ wszystkie
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cookie Settings Modal -->
<div id="cookie-modal" class="fixed inset-0 z-[10000] hidden" role="dialog" aria-label="Ustawienia plikÃ³w cookie" aria-modal="true">
  <!-- Overlay -->
  <div id="cookie-modal-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <!-- Modal -->
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative">
      <!-- Header -->
      <div class="sticky top-0 bg-white border-b border-slate-200 rounded-t-2xl px-6 py-4 flex items-center justify-between">
        <h2 class="text-lg font-bold text-slate-900">ğŸª Ustawienia plikÃ³w cookie</h2>
        <button id="cookie-modal-close" class="text-slate-400 hover:text-slate-600 transition-colors p-1" aria-label="Zamknij">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>

      <!-- Content -->
      <div class="px-6 py-5 space-y-5">
        <p class="text-slate-600 text-sm leading-relaxed">
          PoniÅ¼ej moÅ¼esz wybraÄ‡, na ktÃ³re kategorie plikÃ³w cookie wyraÅ¼asz zgodÄ™. 
          NiezbÄ™dne pliki cookie sÄ… zawsze aktywne, poniewaÅ¼ bez nich strona nie moÅ¼e dziaÅ‚aÄ‡ prawidÅ‚owo.
        </p>

        <!-- NiezbÄ™dne (zawsze wÅ‚Ä…czone) -->
        <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-slate-900 text-sm">NiezbÄ™dne</h3>
            <span class="text-xs font-medium text-slate-500 bg-slate-200 px-2.5 py-1 rounded-full">Zawsze aktywne</span>
          </div>
          <p class="text-slate-500 text-xs leading-relaxed">
            Wymagane do prawidÅ‚owego dziaÅ‚ania strony: zapamiÄ™tanie Twoich preferencji cookie, 
            obsÅ‚uga formularzy, bezpieczeÅ„stwo. Nie zbierajÄ… danych osobowych w celach marketingowych.
          </p>
        </div>

        <!-- Analityczne -->
        <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-bold text-slate-900 text-sm">Analityczne</h3>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="cookie-analytics" class="sr-only peer" />
              <div class="w-10 h-5 bg-slate-300 peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary-600"></div>
            </label>
          </div>
          <p class="text-slate-500 text-xs leading-relaxed">
            Google Analytics (GA4) â€” pozwalajÄ… nam zrozumieÄ‡, jak odwiedzajÄ…cy korzystajÄ… ze strony: 
            ktÃ³re strony odwiedzajÄ…, ile czasu spÄ™dzajÄ…, skÄ…d przychodzÄ…. Dane sÄ… anonimizowane 
            (skrÃ³cony IP). PomagajÄ… nam ulepszaÄ‡ treÅ›ci i doÅ›wiadczenie uÅ¼ytkownika.
          </p>
          <div class="mt-2 text-xs text-slate-400">
            <span class="font-medium">Dostawca:</span> Google LLC Â· 
            <span class="font-medium">Cookies:</span> _ga, _ga_* Â· 
            <span class="font-medium">Wygasa:</span> 14 mies. Â· 
            <a href="https://policies.google.com/privacy" target="_blank" rel="noopener" class="text-primary-500 hover:underline">Polityka prywatnoÅ›ci Google</a>
          </div>
        </div>

        <!-- Informacja prawna -->
        <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
          <p class="text-blue-800 text-xs leading-relaxed">
            <strong>Podstawa prawna:</strong> Art. 6 ust. 1 lit. a) RODO â€” zgoda osoby, ktÃ³rej dane dotyczÄ…. 
            Art. 173 ust. 1 Prawa Telekomunikacyjnego. ZgodÄ™ moÅ¼esz wycofaÄ‡ w kaÅ¼dej chwili 
            klikajÄ…c <strong>â€Cookies"</strong> w stopce strony. Wycofanie zgody nie wpÅ‚ywa na 
            zgodnoÅ›Ä‡ z prawem przetwarzania dokonanego przed jej wycofaniem.
          </p>
        </div>
      </div>

      <!-- Footer -->
      <div class="sticky bottom-0 bg-white border-t border-slate-200 rounded-b-2xl px-6 py-4 flex flex-col sm:flex-row gap-2 sm:gap-3">
        <button id="cookie-save-settings" class="flex-1 px-5 py-2.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors">
          Zapisz mÃ³j wybÃ³r
        </button>
        <button id="cookie-accept-all-modal" class="flex-1 px-5 py-2.5 text-sm font-bold text-white bg-primary-600 hover:bg-primary-700 rounded-lg transition-colors">
          AkceptujÄ™ wszystkie
        </button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ GA_ID }}>
(function() {
  'use strict';

  // ========== CONFIG ==========
  const COOKIE_NAME = 'cookie_consent';
  const COOKIE_DAYS = 365; // 12 miesiÄ™cy
  const GA_MEASUREMENT_ID = GA_ID;

  // ========== COOKIE HELPERS ==========
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${d.toUTCString()};path=/;SameSite=Lax;Secure`;
  }

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    if (match) {
      try { return JSON.parse(decodeURIComponent(match[2])); }
      catch { return null; }
    }
    return null;
  }

  function deleteCookie(name) {
    document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Lax;Secure`;
  }

  // ========== GA4 MANAGEMENT ==========
  function loadGA() {
    // Zapobiegaj wielokrotnemu Å‚adowaniu
    if (document.getElementById('ga-script')) return;

    // ZaÅ‚aduj gtag.js
    const script = document.createElement('script');
    script.id = 'ga-script';
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`;
    document.head.appendChild(script);

    // Inicjalizuj gtag z anonimizacjÄ… IP
    window.dataLayer = window.dataLayer || [];
    function gtag() { window.dataLayer.push(arguments); }
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', GA_MEASUREMENT_ID, {
      anonymize_ip: true,
      cookie_flags: 'SameSite=Lax;Secure',
    });
  }

  function removeGA() {
    // UsuÅ„ skrypt
    const script = document.getElementById('ga-script');
    if (script) script.remove();

    // UsuÅ„ cookies GA
    const cookies = document.cookie.split(';');
    cookies.forEach(c => {
      const name = c.split('=')[0].trim();
      if (name.startsWith('_ga') || name.startsWith('_gid') || name.startsWith('_gat')) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.ebookcopywriting.pl`;
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
      }
    });

    // WyÅ‚Ä…cz GA
    window[`ga-disable-${GA_MEASUREMENT_ID}`] = true;
  }

  // ========== CONSENT MANAGEMENT ==========
  function saveConsent(analytics) {
    const consent = {
      necessary: true,       // zawsze true
      analytics: !!analytics,
      timestamp: new Date().toISOString(),
      version: '1.0',
    };

    setCookie(COOKIE_NAME, consent, COOKIE_DAYS);

    // Zastosuj decyzjÄ™
    if (consent.analytics) {
      loadGA();
    } else {
      removeGA();
    }

    // Ukryj banner i modal
    hideBanner();
    hideModal();
  }

  function getConsent() {
    return getCookie(COOKIE_NAME);
  }

  // ========== UI ==========
  const banner = document.getElementById('cookie-banner');
  const modal = document.getElementById('cookie-modal');
  const analyticsCheckbox = document.getElementById('cookie-analytics');

  function showBanner() {
    if (banner) {
      banner.classList.remove('hidden');
      banner.style.animation = 'slideUp 0.4s ease-out';
    }
  }

  function hideBanner() {
    if (banner) banner.classList.add('hidden');
  }

  function showModal() {
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      // Ustaw checkbox wg aktualnej zgody
      const consent = getConsent();
      if (analyticsCheckbox) {
        analyticsCheckbox.checked = consent ? consent.analytics : false;
      }
    }
  }

  function hideModal() {
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  // ========== EVENT LISTENERS ==========
  // Banner buttons
  document.getElementById('cookie-accept-all')?.addEventListener('click', () => saveConsent(true));
  document.getElementById('cookie-reject')?.addEventListener('click', () => saveConsent(false));
  document.getElementById('cookie-settings-btn')?.addEventListener('click', () => {
    hideBanner();
    showModal();
  });
  document.getElementById('cookie-show-details')?.addEventListener('click', (e) => {
    e.preventDefault();
    hideBanner();
    showModal();
  });

  // Modal buttons
  document.getElementById('cookie-accept-all-modal')?.addEventListener('click', () => saveConsent(true));
  document.getElementById('cookie-save-settings')?.addEventListener('click', () => {
    saveConsent(analyticsCheckbox?.checked || false);
  });
  document.getElementById('cookie-modal-close')?.addEventListener('click', hideModal);
  document.getElementById('cookie-modal-overlay')?.addEventListener('click', hideModal);

  // ESC key closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) hideModal();
  });

  // Footer "Cookies" button â€” otwiera modal ustawieÅ„
  document.addEventListener('click', (e) => {
    if (e.target.closest('#cookie-settings-trigger') || e.target.closest('[data-cookie-settings]')) {
      e.preventDefault();
      showModal();
    }
  });

  // ========== INIT ==========
  const consent = getConsent();

  if (!consent) {
    // Pierwsza wizyta â€” pokaÅ¼ banner
    // MaÅ‚e opÃ³Åºnienie Å¼eby nie blokowaÄ‡ LCP
    setTimeout(showBanner, 800);
  } else {
    // Zgoda juÅ¼ zapisana â€” zastosuj
    if (consent.analytics) {
      loadGA();
    } else {
      // Upewnij siÄ™ Å¼e GA jest wyÅ‚Ä…czone
      window[`ga-disable-${GA_MEASUREMENT_ID}`] = true;
    }
  }
})();
</script>

<style>
  @keyframes slideUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
</style>
